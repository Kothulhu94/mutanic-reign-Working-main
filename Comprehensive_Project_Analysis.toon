@context "Mutanic Reign: Comprehensive Project Architecture"
@target_directory "d:\GodoTDev\mutanic-reign-Working-main"
@version "2.0 (Post-Audit)"

@core_infrastructure "Foundation & Tooling"
  @singletons
    - `Timekeeper`: Global 10Hz clock. Broadcasts `step` signals. Handles Pause/Resume.
    - `SaveManager`: Master persistence engine. Destructive loading (wipes caravans before re-instantiating).
    - `SceneLoader`: Transition manager for async scene switching.
    - `TroopDatabase` (Node): Singleton catalog of all `TroopType` resources.
    - `Skills` (Autoload): Wrapper for `SkillDatabase` resource.
  @input_handling
    - `Bus.gd`: Player Avatar. Uses `MapManager` for point-and-click traversal.
    - `PlayerCamera.gd`: RTS-style camera controls (Pan/Zoom/Follow).
  @navigation_stack
    - `MapManager`: Modular Pathfinder.
      - *Architecture*: Multi-layer `AStarGrid2D` (Land/Water).
      - *Helpers*: `BoundaryCalculator` (Chunk exits), `GridMasker` (Shapes), `TerrainSynchronizer` (Pixel-to-Weight).

@world_systems "Simulation Layers"
  @settlements "Hub Architecture"
    - `Hub.gd`: Central Coordinator. Uses Dependency Injection for components.
      - **Economy**: `HubEconomyManager` + `HubEconomy` (Stateless Engine).
      - **Trade**: `HubTradingSystem`. Uses EMA-based Pricing (`Base * Clamp(Demand/Supply)`).
      - **Military**: `HubTroopProduction`. Spawns T1->Elite units. Pop Cap penalties.
      - **Layout**: `HubBuildingManager` + `BuildSlots`. 3x3 Grid.
    - **Fleet Management ("The Garage")**:
      - `request_trade_run`: Allocates task to 1. Specialist, 2. Warm Body, 3. New Spawn.
      - `idle_fleet`: Pool of waiting caravans.

  @economy_engine "Resource Simulation"
    - **Pipeline**: Producers (Create) -> Processors (Convert) -> Consumption (Sink).
    - **Consumption Tiers**:
      - `Food` (Servings/10 Pop), `Infrastructure` (Maint/Level), `Medical`, `Luxury`.
      - *Logic*: Prioritizes specific tags (e.g. `meal`) over raw inputs for efficiency.
    - **Math**: Geometric scaling (1.5x Power/Cost per Level).

@entities "Living World"
  @caravans "AI Traders"
    - **Design Doc**: `Docs/CaravanTradeCycle_v2.md`.
    - **FSM**: `IDLE` -> `BUYING_AT_HOME` -> `TRAVELING` -> `EVALUATING` -> `SELLING` -> `RETURNING`.
    - **Logic**: 2-Phase Buying (Mission Priority + Opportunity), Export Cooldowns on failure.
    - **State**: `CaravanState` persists Inventory (via Leader Sheet) and Route.

  @beasts "Polymorphic Enemies"
    - **Base**: `Beast.gd`. Uses `MapManager` (No NavAgent). `CharacterSheet` for stats.
    - **Biomes**:
      - *Grassland*: Scrapjackal (Scavenger), Titan Bison (Hauler), Windrunner (Speed).
      - *Forest*: Thornback Boar (Forage), Canopy Panther (Ambush), Myco Stag.
      - *Lake*: Glassfin (Swarm), Ripple Leviathan (Boss).
      - *Mesa*: Basalt Scuttler (Miner), Cinder Vulture (Patrol).

  @rpg_system "Progression"
    - **Core**: `CharacterSheet` (Stats, Inv, Troops).
    - **Skills**: Trait-based trees. XP gained via Actions (Trading = volume treated).
    - **Perks**: Purchasable upgrades unlocking mechanics (e.g. `industrial_planning`).

@interface "UI & UX"
  @screens
    - `MarketUI`: Dual-mode (Player<->Hub OR Player<->Caravan). Net total visualization.
    - `RecruitmentUI`: Troop purchasing. Respects `max_troop_capacity`.
    - `EncounterUI`: Turn-based Auto-Battler visualization.
    - `HubMenuUI`: Central navigation at settlements.
  @overlays
    - `LootUI`: Post-combat logic.
    - `PauseMenu`: Game state control.

@data_layer "Content Assets"
  - `ItemDB`: Global item registry.
  - `TroopType`: Definitions for 35+ units (Archetype/Tier system).
  - `Building Scripts`: `ProducerBuilding` / `ProcessorBuilding` base classes.

@verification "Testing Strategy"
  - **Manual Suites**: `tests/` folder contains `SceneTree` scripts (`verify_xp_curve.gd`, `test_new_skill_system.gd`).
  - **Runtime**: `timekeeper.step` signals drive all simulation logic, allowing deterministic pause/debug.
